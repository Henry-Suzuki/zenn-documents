---
title: "Auroraのリードレプリカ遅延（Lag）とどう戦うか？読取一貫性を担保する3つのデザインパターン"
emoji: "🫧"
type: "idea"
topics:
  - "パフォーマンス"
  - "sre"
  - "エンジニアリングマネージャー"
  - "モニタリング"
  - "dbre"
published: true
published_at: "2026-01-22 01:11"
---

Amazon Auroraを導入し、リードレプリカ（RR）を増やして参照クエリを分散させる。これはスケーラビリティ向上の王道ですが、高トラフィックな環境では避けて通れない問題が発生します。

それが「リードレプリカの遅延（AuroraReplicaLag）」による「読取一貫性（Read-after-write consistency）」の欠如です。

「ユーザーがプロフィールを更新した直後、画面をリロードしても変更が反映されていない」
こうした挙動は、Writerで更新されたデータがReaderに同期されるまでのわずかな隙（通常は数十ミリ秒以下）に、Readerへクエリが飛ぶことで発生します。

本記事では、著書『実践DBRE Vol.2』の内容をベースに、この遅延とどう向き合い、アプリケーション側でどう制御すべきかの実践的なパターンを解説します。

## 1. Aurora Replica Lag のメカニズム

Auroraは共有ストレージアーキテクチャを採用しているため、従来のMySQLレプリケーション（バイナリログベース）に比べると遅延は極めて小さいのが特徴です。

しかし、以下の要因で遅延はスパイクします。
* **Writer側の高負荷：** 大量の更新クエリによるストレージへの書き込み集中。
* **Reader側のリソース不足：** 複雑な参照クエリによるCPU飽和。
* **ネットワーク競合：** インスタンス間のレプリケーションログの転送待ち。

## 2. 読取一貫性を担保する3つのデザインパターン

すべてをWriterで読み取れば一貫性は保てますが、それではスケーラビリティを捨ててしまいます。DBREは、要件に応じて以下のパターンを使い分けます。

### パターンA：セッション・スティッキネス（書き込み後のみWriter参照）
ユーザーが更新処理（POST/PUT等）を行った直後の一定期間だけ、そのユーザーの参照クエリを強制的にWriter（Primaryエンドポイント）へ飛ばす手法です。

* **実装：** CookieやRedisに「最終更新タイムスタンプ」を保持し、一定秒数以内ならWriter、それ以外はReaderを選択する。
* **メリット：** 参照の大部分をReaderに逃がしつつ、ユーザー体験を損なわない。

### パターンB：重要度によるエンドポイントの分離（Custom Endpoints）
すべてのデータを最新にする必要はありません。
* **Writer：** 決済、認証、重要なステータス更新直後の確認。
* **Custom Reader A（低遅延）：** ユーザーのプロフィール表示など、体感速度が重要なもの。
* **Custom Reader B（遅延許容）：** バッチ処理、ランキング、分析用。

### パターンC：キャッシュによる「見かけの一貫性」の維持
DBのレプリケーションを待つのではなく、アプリケーション層（Redis等）で一貫性を補完します。
* **実装：** 書き込み成功と同時に、分散キャッシュにもデータを書き込む。参照時はまずキャッシュを見に行き、なければReaderを見に行く。

## 3. モニタリングとアラート設計

DBREとして監視すべきは、単なる「遅延時間」だけではありません。

* **AuroraReplicaLag（ミリ秒）：** ReaderがWriterからどれくらい遅れているか。
* **Read Replica I/O / CPU：** 遅延の原因がReader側のリソース枯渇にないか。
* **アプリケーション側のエラー / 不整合報告数：** ユーザー体験にどれだけ影響が出ているかの実測値。

## 結論：スケーラビリティは「一貫性」とのトレードオフである

Auroraを使えば「魔法のようにすべてがスケールする」わけではありません。極限状態では、この「わずかな遅延」が致命的な不整合を生むことがあります。

技術的な制約を理解し、アプリケーション側の実装と組み合わせて「信頼性」を設計する。それこそがDBREの真骨頂です。

## 大規模プロジェクトのリーダー・マネージャーの皆様へ

インフラの設定だけでは解決できない「一貫性」の問題。アプリとDBの境界線でDBREが何をすべきか。その答えを、実戦経験に基づいたノウハウとして1冊にまとめました。限界を超えるスケーラビリティを手に入れたい方は、ぜひチェックしてみてください。

[![実践DBRE Vol.2 大規模システムのスケーラビリティ改善](https://storage.googleapis.com/zenn-user-upload/a1a1a218f0c5-20260120.jpg)](https://amzn.asia/d/dO6znhY)